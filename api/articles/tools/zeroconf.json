{"title":"zeroconf与mDNS","slug":"tools/zeroconf","date":"2021-04-22T15:20:21.000Z","updated":"2024-06-30T10:35:56.312Z","comments":true,"path":"api/articles/tools/zeroconf.json","excerpt":null,"covers":null,"content":"<p>[toc]</p>\n<h2 id=\"基础概念\"><a href=\"#基础概念\" class=\"headerlink\" title=\"基础概念\"></a>基础概念</h2><h3 id=\"路由\"><a href=\"#路由\" class=\"headerlink\" title=\"路由\"></a>路由</h3><p>路由中有以下几种形式</p>\n<p>单播：在网络地址和网络节点之间存在一一对应的关系。</p>\n<p>任播：根据路由拓扑自动决定送到“最近”或“最好”的目的地</p>\n<p>多播：是一种群组通信，它把信息同时传递给一组目的计算机。常指IP多播，组播地址224.0.0.0～224.0.0.255</p>\n<p>广播:向指定网络范围内所以设备发送信息，主机标识段host ID 为全1 的IP 地址为广播地址，ARP、DHCP都使用了广播</p>\n<p>地域性广播：一种“特殊”的多播</p>\n<h3 id=\"DNS\"><a href=\"#DNS\" class=\"headerlink\" title=\"DNS\"></a>DNS</h3><p>Domain Name System,域名服务，将域名和ip地址互相影射的分布式数据库，使用TCP和UDP的53端口</p>\n<p>TCP：面向连接的协议，提供可靠的数据传输，一般服务质量要求比较高的情况，使用这个协议。</p>\n<p>UDP：用户数据报协议，是一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。</p>\n<h2 id=\"zeroConf\"><a href=\"#zeroConf\" class=\"headerlink\" title=\"zeroConf\"></a>zeroConf</h2><p>Zero configuration networking,零配置网络服务规范是一种让用户武穴使用DHCP、DNS等设置就能自动连接设备的一种规范，主要包含以下协议</p>\n<ul>\n<li>Link-Local Address： 无需利用DHCP Server 取得设备地址和IP的相关资料 【RFC3927】</li>\n<li>Multicast Dns： 不需要DNS Server 就可以解决domain 和ip的绑定关系 【RFC6762】</li>\n<li>DNS-SD（dns-based service discovery）： 不需要目录服务器，就可以自动发现设备服务 【RFC6763】</li>\n</ul>\n<h2 id=\"mDNS\"><a href=\"#mDNS\" class=\"headerlink\" title=\"mDNS\"></a>mDNS</h2><h4 id=\"原理和特点\"><a href=\"#原理和特点\" class=\"headerlink\" title=\"原理和特点\"></a>原理和特点</h4><p>Multicast DNS (mDNS)，多播DNS，使用5353端口，组播地址为 <code>224.0.0.251</code> 或 <code>[FF02::FB]</code> 。在一个没有常规DNS服务器的小型网络内可以使用mDNS来实现类似DNS的编程接口、包格式和操作语义,mdns协议使用DNS协议一样的数据包</p>\n<p>若主机开启了mDNS，在进入局域网内时会向224.0.0.251地址发送信息，信息内容包含，ip地址端口号，服务名等；</p>\n<p>同时其mDNS服务会向其它mDNS询问获取局域网内的服务。</p>\n<p>mDNS的顶级域名用 <code>.local</code> 和普通域名区分开的.</p>\n<h2 id=\"DNS-SD\"><a href=\"#DNS-SD\" class=\"headerlink\" title=\"DNS-SD\"></a>DNS-SD</h2><p>DNS Service Discovery是一种基于 DNS 协议的服务发现协议，设备之间可以通过该协议自动发现服务</p>\n<p>使用如下格式</p>\n<p><code>&lt;instance&gt;.&lt;service&gt;.&lt;transport&gt;.&lt;domain&gt;</code></p>\n<h4 id=\"流程\"><a href=\"#流程\" class=\"headerlink\" title=\"流程\"></a>流程</h4><p>启动DNS-SD的主机在进入局域网后或启动DNS-SD后会向组播地址发送组播消息，包括主机名、IP信息等，其他拥有相应服务的主机会响应</p>\n<p>关闭DNS-SD的主机在关闭DNS-SD后会向组播地址刷新组播消息，清除信息</p>\n<h2 id=\"技术应用\"><a href=\"#技术应用\" class=\"headerlink\" title=\"技术应用\"></a>技术应用</h2><p>avahi、bonjour、WiSe-Zeroconf是zeroconf协议的常用实现</p>\n<p>在苹果家族中常使用Bonjour、linux中常用avahi、在嵌入式领域常用WiSe-Zeroconf</p>\n<h3 id=\"小玩具\"><a href=\"#小玩具\" class=\"headerlink\" title=\"小玩具\"></a>小玩具</h3><h4 id=\"安装-amp-下载-rocket\"><a href=\"#安装-amp-下载-rocket\" class=\"headerlink\" title=\"安装&amp;下载:rocket:\"></a>安装&amp;下载:rocket:</h4><p>使用golang的<code>zeroconf</code>包进行简单封装的玩具</p>\n<p>server端：<a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-server-linux-amd64\">amd64-linux</a> <a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-server-mac-amd64\">amd64-mac</a> <a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-server-win-amd64.exe\">amd64-win</a></p>\n<p>client端：<a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-client-linux-amd64\">amd64-linux</a> <a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-client-mac-amd64\">amd64-mac</a> <a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-client-win-amd64.exe\">amd64-win</a></p>\n<h4 id=\"演示\"><a href=\"#演示\" class=\"headerlink\" title=\"演示\"></a>演示</h4><h3 id=\"AVAHI\"><a href=\"#AVAHI\" class=\"headerlink\" title=\"AVAHI\"></a>AVAHI</h3><h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install nss-mDNS avahi avahi-tools -y</span><br></pre></td></tr></table></figure>\n\n<p>avahi-tools是avahi的工具包，包含avahi-browse、avahi-publish-address 、 avahi-resolve-host-nameavahi-browse-domains、avahi-publish-service、avahi-set-host-name、avahi-daemon、avahi-resolve、avahi-publish、avahi-resolve-address</p>\n<p>常用的avahi-browse的功能如下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-D --browse-domains  浏览域而不是服务</span><br><span class=\"line\">-a --all             显示所有服务，忽略类型</span><br><span class=\"line\">-d --domain=DOMAIN   要浏览的域</span><br><span class=\"line\">-v --verbose         启用详述模式</span><br><span class=\"line\">-t --terminate       导出一个完整列表后终止</span><br><span class=\"line\">-c --cache           导出缓存中的所有条目后终止</span><br><span class=\"line\">-l --ignore-local    忽略本地服务</span><br><span class=\"line\">-r --resolve         解析找到的服务</span><br><span class=\"line\">-f --no-fail         如果 daemon 不可用也不中断</span><br><span class=\"line\">-p --parsable        输出可解析格式</span><br><span class=\"line\">-k --no-db-lookup    不查询服务类型</span><br><span class=\"line\">-b --dump-db         导出服务类型数据库</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"添加服务\"><a href=\"#添加服务\" class=\"headerlink\" title=\"添加服务\"></a>添加服务</h4><p>创建文件 /etc/avahi/services/wltHello.service</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version&#x3D;&quot;1.0&quot; standalone&#x3D;&#39;no&#39;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE service-group SYSTEM &quot;avahi-service.dtd&quot;&gt;</span><br><span class=\"line\">&lt;service-group&gt;</span><br><span class=\"line\">    &lt;name&gt;wlt@*Hello&lt;&#x2F;name&gt;</span><br><span class=\"line\">    &lt;service&gt;</span><br><span class=\"line\">        &lt;type&gt;_wlt@*Hello._tcp&lt;&#x2F;type&gt;</span><br><span class=\"line\">        &lt;port&gt;5678&lt;&#x2F;port&gt;</span><br><span class=\"line\">    &lt;&#x2F;service&gt;</span><br><span class=\"line\">&lt;&#x2F;service-group&gt;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"重启服务\"><a href=\"#重启服务\" class=\"headerlink\" title=\"重启服务\"></a>重启服务</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl restart dbus</span><br><span class=\"line\">systemctl restart avahi-daemon</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查询服务\"><a href=\"#查询服务\" class=\"headerlink\" title=\"查询服务\"></a>查询服务</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# avahi-browse -vrtp _wlt@*Hello._tcp</span><br><span class=\"line\">+;eth0;IPv4;wlt\\064\\042Hello;_wlt\\064\\042Hello._tcp;local</span><br><span class=\"line\">=;eth0;IPv4;wlt\\064\\042Hello;_wlt\\064\\042Hello._tcp;local;linux.local;172.20.65.36;5678;</span><br></pre></td></tr></table></figure>\n\n<p>通过avahi-browse即可在局域网内通过avahi-browse发现服务</p>\n<p>在实际生产中，我们可以在开启服务时同时添加mDNS服务，消费者机器通过avahi-browse查询服务得到开启服务的ip地址，再进一步与服务建立链接。除此之外avahi还暴露了一些api：<a href=\"https://www.avahi.org/doxygen/v0.7/html/index.html\">https://www.avahi.org/doxygen/v0.7/html/index.html</a></p>\n","more":"<p>[toc]</p>\n<h2 id=\"基础概念\"><a href=\"#基础概念\" class=\"headerlink\" title=\"基础概念\"></a>基础概念</h2><h3 id=\"路由\"><a href=\"#路由\" class=\"headerlink\" title=\"路由\"></a>路由</h3><p>路由中有以下几种形式</p>\n<p>单播：在网络地址和网络节点之间存在一一对应的关系。</p>\n<p>任播：根据路由拓扑自动决定送到“最近”或“最好”的目的地</p>\n<p>多播：是一种群组通信，它把信息同时传递给一组目的计算机。常指IP多播，组播地址224.0.0.0～224.0.0.255</p>\n<p>广播:向指定网络范围内所以设备发送信息，主机标识段host ID 为全1 的IP 地址为广播地址，ARP、DHCP都使用了广播</p>\n<p>地域性广播：一种“特殊”的多播</p>\n<h3 id=\"DNS\"><a href=\"#DNS\" class=\"headerlink\" title=\"DNS\"></a>DNS</h3><p>Domain Name System,域名服务，将域名和ip地址互相影射的分布式数据库，使用TCP和UDP的53端口</p>\n<p>TCP：面向连接的协议，提供可靠的数据传输，一般服务质量要求比较高的情况，使用这个协议。</p>\n<p>UDP：用户数据报协议，是一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。</p>\n<h2 id=\"zeroConf\"><a href=\"#zeroConf\" class=\"headerlink\" title=\"zeroConf\"></a>zeroConf</h2><p>Zero configuration networking,零配置网络服务规范是一种让用户武穴使用DHCP、DNS等设置就能自动连接设备的一种规范，主要包含以下协议</p>\n<ul>\n<li>Link-Local Address： 无需利用DHCP Server 取得设备地址和IP的相关资料 【RFC3927】</li>\n<li>Multicast Dns： 不需要DNS Server 就可以解决domain 和ip的绑定关系 【RFC6762】</li>\n<li>DNS-SD（dns-based service discovery）： 不需要目录服务器，就可以自动发现设备服务 【RFC6763】</li>\n</ul>\n<h2 id=\"mDNS\"><a href=\"#mDNS\" class=\"headerlink\" title=\"mDNS\"></a>mDNS</h2><h4 id=\"原理和特点\"><a href=\"#原理和特点\" class=\"headerlink\" title=\"原理和特点\"></a>原理和特点</h4><p>Multicast DNS (mDNS)，多播DNS，使用5353端口，组播地址为 <code>224.0.0.251</code> 或 <code>[FF02::FB]</code> 。在一个没有常规DNS服务器的小型网络内可以使用mDNS来实现类似DNS的编程接口、包格式和操作语义,mdns协议使用DNS协议一样的数据包</p>\n<p>若主机开启了mDNS，在进入局域网内时会向224.0.0.251地址发送信息，信息内容包含，ip地址端口号，服务名等；</p>\n<p>同时其mDNS服务会向其它mDNS询问获取局域网内的服务。</p>\n<p>mDNS的顶级域名用 <code>.local</code> 和普通域名区分开的.</p>\n<h2 id=\"DNS-SD\"><a href=\"#DNS-SD\" class=\"headerlink\" title=\"DNS-SD\"></a>DNS-SD</h2><p>DNS Service Discovery是一种基于 DNS 协议的服务发现协议，设备之间可以通过该协议自动发现服务</p>\n<p>使用如下格式</p>\n<p><code>&lt;instance&gt;.&lt;service&gt;.&lt;transport&gt;.&lt;domain&gt;</code></p>\n<h4 id=\"流程\"><a href=\"#流程\" class=\"headerlink\" title=\"流程\"></a>流程</h4><p>启动DNS-SD的主机在进入局域网后或启动DNS-SD后会向组播地址发送组播消息，包括主机名、IP信息等，其他拥有相应服务的主机会响应</p>\n<p>关闭DNS-SD的主机在关闭DNS-SD后会向组播地址刷新组播消息，清除信息</p>\n<h2 id=\"技术应用\"><a href=\"#技术应用\" class=\"headerlink\" title=\"技术应用\"></a>技术应用</h2><p>avahi、bonjour、WiSe-Zeroconf是zeroconf协议的常用实现</p>\n<p>在苹果家族中常使用Bonjour、linux中常用avahi、在嵌入式领域常用WiSe-Zeroconf</p>\n<h3 id=\"小玩具\"><a href=\"#小玩具\" class=\"headerlink\" title=\"小玩具\"></a>小玩具</h3><h4 id=\"安装-amp-下载-rocket\"><a href=\"#安装-amp-下载-rocket\" class=\"headerlink\" title=\"安装&amp;下载:rocket:\"></a>安装&amp;下载:rocket:</h4><p>使用golang的<code>zeroconf</code>包进行简单封装的玩具</p>\n<p>server端：<a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-server-linux-amd64\">amd64-linux</a> <a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-server-mac-amd64\">amd64-mac</a> <a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-server-win-amd64.exe\">amd64-win</a></p>\n<p>client端：<a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-client-linux-amd64\">amd64-linux</a> <a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-client-mac-amd64\">amd64-mac</a> <a href=\"http://192.168.200.150/mirror/longtao.wu/tools/mdnsToy/mdns-client-win-amd64.exe\">amd64-win</a></p>\n<h4 id=\"演示\"><a href=\"#演示\" class=\"headerlink\" title=\"演示\"></a>演示</h4><h3 id=\"AVAHI\"><a href=\"#AVAHI\" class=\"headerlink\" title=\"AVAHI\"></a>AVAHI</h3><h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install nss-mDNS avahi avahi-tools -y</span><br></pre></td></tr></table></figure>\n\n<p>avahi-tools是avahi的工具包，包含avahi-browse、avahi-publish-address 、 avahi-resolve-host-nameavahi-browse-domains、avahi-publish-service、avahi-set-host-name、avahi-daemon、avahi-resolve、avahi-publish、avahi-resolve-address</p>\n<p>常用的avahi-browse的功能如下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-D --browse-domains  浏览域而不是服务</span><br><span class=\"line\">-a --all             显示所有服务，忽略类型</span><br><span class=\"line\">-d --domain=DOMAIN   要浏览的域</span><br><span class=\"line\">-v --verbose         启用详述模式</span><br><span class=\"line\">-t --terminate       导出一个完整列表后终止</span><br><span class=\"line\">-c --cache           导出缓存中的所有条目后终止</span><br><span class=\"line\">-l --ignore-local    忽略本地服务</span><br><span class=\"line\">-r --resolve         解析找到的服务</span><br><span class=\"line\">-f --no-fail         如果 daemon 不可用也不中断</span><br><span class=\"line\">-p --parsable        输出可解析格式</span><br><span class=\"line\">-k --no-db-lookup    不查询服务类型</span><br><span class=\"line\">-b --dump-db         导出服务类型数据库</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"添加服务\"><a href=\"#添加服务\" class=\"headerlink\" title=\"添加服务\"></a>添加服务</h4><p>创建文件 /etc/avahi/services/wltHello.service</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version&#x3D;&quot;1.0&quot; standalone&#x3D;&#39;no&#39;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE service-group SYSTEM &quot;avahi-service.dtd&quot;&gt;</span><br><span class=\"line\">&lt;service-group&gt;</span><br><span class=\"line\">    &lt;name&gt;wlt@*Hello&lt;&#x2F;name&gt;</span><br><span class=\"line\">    &lt;service&gt;</span><br><span class=\"line\">        &lt;type&gt;_wlt@*Hello._tcp&lt;&#x2F;type&gt;</span><br><span class=\"line\">        &lt;port&gt;5678&lt;&#x2F;port&gt;</span><br><span class=\"line\">    &lt;&#x2F;service&gt;</span><br><span class=\"line\">&lt;&#x2F;service-group&gt;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"重启服务\"><a href=\"#重启服务\" class=\"headerlink\" title=\"重启服务\"></a>重启服务</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl restart dbus</span><br><span class=\"line\">systemctl restart avahi-daemon</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查询服务\"><a href=\"#查询服务\" class=\"headerlink\" title=\"查询服务\"></a>查询服务</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# avahi-browse -vrtp _wlt@*Hello._tcp</span><br><span class=\"line\">+;eth0;IPv4;wlt\\064\\042Hello;_wlt\\064\\042Hello._tcp;local</span><br><span class=\"line\">=;eth0;IPv4;wlt\\064\\042Hello;_wlt\\064\\042Hello._tcp;local;linux.local;172.20.65.36;5678;</span><br></pre></td></tr></table></figure>\n\n<p>通过avahi-browse即可在局域网内通过avahi-browse发现服务</p>\n<p>在实际生产中，我们可以在开启服务时同时添加mDNS服务，消费者机器通过avahi-browse查询服务得到开启服务的ip地址，再进一步与服务建立链接。除此之外avahi还暴露了一些api：<a href=\"https://www.avahi.org/doxygen/v0.7/html/index.html\">https://www.avahi.org/doxygen/v0.7/html/index.html</a></p>\n","categories":[{"name":"编程技术","path":"api/categories/编程技术.json"}],"tags":[{"name":"应用","path":"api/tags/应用.json"}]}